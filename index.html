<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f2f5;}
header{background:#1e1e2f;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
nav ul li{position:relative;}
nav ul li a{color:white;text-decoration:none;cursor:pointer;}
nav ul li ul{display:none;position:absolute;top:30px;left:0;background:#333;padding:10px;border-radius:5px;max-height:200px;overflow-y:auto;white-space:nowrap;}
nav ul li:hover ul{display:block;}
.group-list{margin:20px 0;}
.group{background:white;padding:10px;margin-bottom:5px;border-radius:5px;display:flex;justify-content:space-between;align-items:center;}
.chat-message{background:white;padding:10px;margin-bottom:10px;border-radius:5px;position:relative;word-break:break-word;}
.chat-message .actions{position:absolute;top:0;right:0;display:flex;gap:5px;}
.announcement-bar{background:#ffcc00;color:#000;padding:10px;overflow:hidden;white-space:nowrap;}
.announcement-bar:nth-child(2){background:#00ccff;color:#000;}
.announcement-text{display:inline-block;padding-left:100%;animation:marquee 15s linear infinite;}
@keyframes marquee{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}
#chatMessages{max-height:400px;overflow-y:auto;}
#chatInput{width:70%;padding:10px;border-radius:5px;border:1px solid #ccc;}
button{padding:10px 15px;border:none;border-radius:5px;background:#1e1e2f;color:white;cursor:pointer;}
</style>
</head>
<body>

<header>
<h1>Mini Messenger</h1>
<nav>
<ul>
<li><a>Navigation</a>
<ul>
<li><a onclick="showSection('groups')">Groupes</a></li>
<li><a onclick="showSection('chat')">Chat</a></li>
</ul></li>
<li><a>Liens</a>
<ul id="externalLinks"></ul>
</li>
<li><a>Fuseau Horaire</a>
<ul id="timeZones"></ul>
</li>
</ul>
</nav>
</header>

<div class="announcement-bar" id="announcementBar1"><span class="announcement-text" id="announcementText1"></span></div>
<div class="announcement-bar" id="announcementBar2"><span class="announcement-text" id="announcementText2"></span></div>

<section id="groups" style="padding:20px;">
<h2>Mes Groupes <input type="text" id="searchGroup" placeholder="Rechercher" onkeyup="searchGroups()"></h2>
<div class="group-list" id="groupList"></div>
<input type="text" id="newGroup" placeholder="Nom du groupe"><button onclick="createGroup()">CrÃ©er</button>
</section>

<section id="chat" style="display:none;padding:20px;">
<h2 id="currentGroupTitle">Chat</h2>
<div id="chatMessages"></div>
<input type="text" id="chatInput" placeholder="Ã‰crire un message...">
<input type="file" id="mediaInput" style="display:none;" onchange="sendMedia(event)">
<button onclick="sendMessage()">Envoyer</button>
<button onclick="addMedia()">ðŸ“Ž</button>
</section>

<section id="adminPanel" style="display:none;padding:10px;background:#eee;margin:20px;border-radius:5px;">
<h3>Admin</h3>
<input type="text" id="targetUserId" placeholder="ID utilisateur Ã  bloquer/dÃ©bloquer">
<button onclick="blockUser()">Bloquer</button>
<button onclick="unblockUser()">DÃ©bloquer</button>
<div id="blockedList"></div>
<hr>
<input type="text" id="announcementInput" placeholder="Texte de lâ€™annonce">
<button onclick="setAnnouncement()">Publier</button>
<button onclick="clearAnnouncement()">Supprimer</button>
<hr>
<input type="text" id="linkInput" placeholder="Lien externe">
<button onclick="addExternalLink()">Ajouter</button>
</section>

<div style="margin:20px;">
<input type="text" id="adminCodeInput" placeholder="Code admin">
<button onclick="checkAdmin()">Valider</button>
</div>

<script>
let userId=localStorage.getItem('userId')||crypto.randomUUID(); localStorage.setItem('userId',userId);
let isAdmin=false;
let blockedUsers=[];
let groups=[];
let currentGroup=null;
let privateUser=null;
let externalLinks=[];

// Fuseaux horaires
const zones=["Europe/Paris","America/New_York","Asia/Tokyo","Africa/Douala"];
zones.forEach(zone=>{
  const li=document.createElement('li');
  li.innerHTML=`<a onclick="showTime('${zone}')">${zone}</a>`;
  document.getElementById('timeZones').appendChild(li);
});
function showTime(zone){
  const time=new Date().toLocaleString('fr-FR',{timeZone:zone});
  alert(`Heure actuelle Ã  ${zone}: ${time}`);
}

// Admin
const adminCode='233233';
function checkAdmin(){ 
  if(document.getElementById('adminCodeInput').value===adminCode){
    isAdmin=true; document.getElementById('adminPanel').style.display='block';
    renderGroups();
  } else alert("Code incorrect");
}

// Annonces
let announcement1='',announcement2='';
function setAnnouncement(){ if(!isAdmin) return; announcement1=document.getElementById('announcementInput').value; announcement2=document.getElementById('announcementInput').value; renderAnnouncements(); }
function clearAnnouncement(){ announcement1='';announcement2=''; renderAnnouncements(); }
function renderAnnouncements(){ document.getElementById('announcementText1').textContent=announcement1; document.getElementById('announcementText2').textContent=announcement2; }

// Bloquer/DÃ©bloquer
function blockUser(){ const t=document.getElementById('targetUserId').value.trim(); if(t&&!blockedUsers.includes(t)) blockedUsers.push(t); updateBlockedList(); }
function unblockUser(){ const t=document.getElementById('targetUserId').value.trim(); blockedUsers=blockedUsers.filter(x=>x!==t); updateBlockedList(); }
function updateBlockedList(){ document.getElementById('blockedList').textContent="BloquÃ©s: "+(blockedUsers.length?blockedUsers.join(', '):"Aucun"); }

// Groupes
function createGroup(){ const name=document.getElementById('newGroup').value.trim(); if(!name) return; const id=Date.now(); groups.push({id,name,members:[userId],messages:[]}); document.getElementById('newGroup').value=''; renderGroups(); }
function renderGroups(){ const container=document.getElementById('groupList'); container.innerHTML=''; groups.forEach(g=>{ const div=document.createElement('div'); div.className='group'; div.innerHTML=`<span onclick="openGroup(${g.id})">${g.name}</span> <span>${g.members.length} abonnÃ©s</span>`; container.appendChild(div); }); }
function searchGroups(){ const val=document.getElementById('searchGroup').value.toLowerCase(); Array.from(document.getElementById('groupList').children).forEach(div=>div.style.display=div.innerText.toLowerCase().includes(val)?'flex':'none'); }
function openGroup(id){ currentGroup=id; showSection('chat'); document.getElementById('currentGroupTitle').textContent='Chat: '+groups.find(g=>g.id===id).name; }

// Chat
function sendMessage(){ 
  if(!currentGroup && !privateUser) return; 
  const text=document.getElementById('chatInput').value.trim(); if(!text) return; 
  let msg={user:userId,text,media_url:null,media_type:null};
  if(privateUser){ msg.to=privateUser; } 
  else groups.find(g=>g.id===currentGroup).messages.push(msg);
  document.getElementById('chatInput').value=''; renderMessages(); 
}
function renderMessages(){ 
  const container=document.getElementById('chatMessages'); container.innerHTML=''; 
  let messages=[]; 
  if(privateUser){ groups.forEach(g=>{ g.messages?.forEach(m=>{ if(m.user===userId || m.to===userId) messages.push(m); }); }); } 
  else messages=groups.find(g=>g.id===currentGroup).messages; 
  messages.forEach(m=>{ const div=document.createElement('div'); div.className='chat-message'; let media=''; if(m.media_url){ if(m.media_type.startsWith('image')) media=`<img src="${m.media_url}" style="max-width:100%;">`; else if(m.media_type.startsWith('video')) media=`<video src="${m.media_url}" controls style="max-width:100%;"></video>`; else if(m.media_type.startsWith('audio')) media=`<audio src="${m.media_url}" controls></audio>`; else media=`<a href="${m.media_url}" target="_blank">ðŸ“„ Document</a>`; } div.innerHTML=`<strong>${m.user}</strong>: ${m.text||''} ${media}`; container.appendChild(div); }); container.scrollTop=container.scrollHeight;
}
function addMedia(){) return; 
const reader=new FileReader();
reader.onload=async e=>{
  await supabase.from('messages_groupes').insert([{
    group_id: currentGroup,
    user: userId,
    text: '',
    media: e.target.result,
    media_type: file.type,
    timestamp: new Date().toISOString()
  }]);
  renderGroupMessages();
};
reader.readAsDataURL(file);
}

async function renderGroupMessages(){
  if(!currentGroup) return;
  const {data,error}=await supabase.from('messages_groupes').select('*').eq('group_id',currentGroup).order('timestamp',{ascending:true});
  const container=document.getElementById('chatMessages');
  container.innerHTML='';
  if(data){
    data.forEach(msg=>{
      const div=document.createElement('div');
      div.className='chat-message';
      let mediaHtml='';
      if(msg.media){
        if(msg.media_type.startsWith('image')) mediaHtml=`<img src="${msg.media}">`;
        else if(msg.media_type.startsWith('video')) mediaHtml=`<video src="${msg.media}" controls></video>`;
        else if(msg.media_type.startsWith('audio')) mediaHtml=`<audio src="${msg.media}" controls></audio>`;
        else mediaHtml=`<a href="${msg.media}" target="_blank">Fichier</a>`;
      }
      div.innerHTML=`<strong>${msg.user}</strong> [${new Date(msg.timestamp).toLocaleTimeString()}]: ${msg.text||''} ${mediaHtml}`;
      if(msg.user===userId || isAdmin){
        const actions=document.createElement('div');
        actions.className='actions';
        const editBtn=document.createElement('button');
        editBtn.textContent='âœï¸';
        editBtn.onclick=async ()=>{ const newText=prompt('Modifier message:',msg.text); if(newText!==null){ await supabase.from('messages_groupes').update({text:newText}).eq('id',msg.id); renderGroupMessages(); }};
        const delBtn=document.createElement('button');
        delBtn.textContent='ðŸ—‘ï¸';
        delBtn.onclick=async ()=>{ await supabase.from('messages_groupes').delete().eq('id',msg.id); renderGroupMessages(); };
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        div.appendChild(actions);
      }
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
  }
}

// Messages privÃ©s
function openPrivateChat(otherUser){
  privateUser=otherUser;
  showSection('private');
  document.getElementById('privateTitle').textContent='Conversation avec '+otherUser;
  renderPrivateMessages();
}

async function sendPrivateMessage(){
  if(!privateUser) return;
  const text=document.getElementById('privateInput').value.trim(); if(!text) return;
  await supabase.from('messages_prives').insert([{user1:userId,user2:privateUser,text,media:null,timestamp:new Date().toISOString()}]);
  document.getElementById('privateInput').value='';
  renderPrivateMessages();
}

function addPrivateMedia(){ document.getElementById('privateMedia').click(); }
async function sendPrivateMedia(event){ const file=event.target.files[0]; if(!file || !privateUser) return;
const reader=new FileReader();
reader.onload=async e=>{
  await supabase.from('messages_prives').insert([{
    user1:userId,
    user2:privateUser,
    text:'',
    media:e.target.result,
    media_type:file.type,
    timestamp:new Date().toISOString()
  }]);
  renderPrivateMessages();
};
reader.readAsDataURL(file);
}

async function renderPrivateMessages(){
  if(!privateUser) return;
  const {data,error}=await supabase.from('messages_prives').select('*')
    .or(`user1.eq.${userId},user2.eq.${userId}`)
    .order('timestamp',{ascending:true});
  const container=document.getElementById('privateMessages');
  container.innerHTML='';
  if(data){
    data.filter(m=>m.user1===privateUser || m.user2===privateUser).forEach(msg=>{
      const div=document.createElement('div');
      div.className='chat-message';
      let mediaHtml='';
      if(msg.media){
        if(msg.media_type.startsWith('image')) mediaHtml=`<img src="${msg.media}">`;
        else if(msg.media_type.startsWith('video')) mediaHtml=`<video src="${msg.media}" controls></video>`;
        else if(msg.media_type.startsWith('audio')) mediaHtml=`<audio src="${msg.media}" controls></audio>`;
        else mediaHtml=`<a href="${msg.media}" target="_blank">Fichier</a>`;
      }
      div.innerHTML=`<strong>${msg.user1===userId?userId:privateUser}</strong> [${new Date(msg.timestamp).toLocaleTimeString()}]: ${msg.text||''} ${mediaHtml}`;
      if(msg.user1===userId || isAdmin){
        const actions=document.createElement('div');
        actions.className='actions';
        const editBtn=document.createElement('button');
        editBtn.textContent='âœï¸';
        editBtn.onclick=async ()=>{ const newText=prompt('Modifier message:',msg.text); if(newText!==null){ await supabase.from('messages_prives').update({text:newText}).eq('id',msg.id); renderPrivateMessages(); }};
        const delBtn=document.createElement('button');
        delBtn.textContent='ðŸ—‘ï¸';
        delBtn.onclick=async ()=>{ await supabase.from('messages_prives').delete().eq('id',msg.id); renderPrivateMessages(); };
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        div.appendChild(actions);
      }
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
  }
}

// Auto clean messages >24h
async function cleanOldMessages(){
  const limit=new Date(Date.now()-24*60*60*1000).toISOString();
  await supabase.from('messages_groupes').delete().lt('timestamp',limit);
  await supabase.from('messages_prives').delete().lt('timestamp',limit);
}

// Initialisation
renderGroups();
renderAnnouncements();
setInterval(renderGroupMessages,5000);
setInterval(renderPrivateMessages,5000);
setInterval(cleanOldMessages,60*60*1000); // toutes les heures
</script>
</body>
</html>