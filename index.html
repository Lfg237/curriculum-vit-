<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini Secr√©tariat Complet</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg1:#ffefd5;--bg2:#ffe4f0;--accent:#ff6b6b;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Inter,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:#222;overflow-x:hidden;}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,0.06);position:sticky;top:0;z-index:10;}
.brand{display:flex;align-items:center;gap:12px;}
.brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(45deg,#ff9a9e,#fad0c4);display:flex;align-items:center;justify-content:center;font-size:28px;}
.brand h1{font-family:Dancing Script,cursive;margin:0;font-size:20px;color:var(--accent);}
.navbar{overflow-x:auto;white-space:nowrap;padding:10px;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px);}
.navbar button{display:inline-block;margin-right:8px;padding:10px 14px;border-radius:999px;border:0;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6));box-shadow:0 4px 8px rgba(0,0,0,0.06);cursor:pointer;font-size:11px;}
.container{padding:8px;display:flex;justify-content:center;flex-direction:column;align-items:center;}
.main{background:rgba(255,255,255,0.9);padding:8mm;border-radius:12px;width:95%;max-width:600px;min-height:105mm;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;font-size:12px;line-height:1.4;word-wrap: break-word;}
.doc-title{font-family:Dancing Script,cursive;font-size:18px;margin:6px 0;}
.handwritten{font-family:'Dancing Script',cursive;font-weight:700;font-size:16px;color:#2c3e50;}
.doc-photo{width:60px;height:60px;object-fit:cover;border-radius:50%;border:2px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;margin:4px;float:left;}
.field{margin-bottom:12px;}
.field label{display:block;font-size:11px;color:#555;margin-bottom:4px;font-weight:600;}
.field textarea{width:100%;min-height:250px;max-height:600px;padding:8px;border:1px solid #eee;border-radius:6px;font-size:12px;line-height:1.4;resize:vertical;overflow-y:auto;background-color:#fff8dc;}
.btn{padding:6px 10px;border-radius:8px;border:0;cursor:pointer;margin-top:4px;font-size:12px;}
.btn-primary{background:linear-gradient(90deg,#4facfe,#00f2fe);color:white;}
.btn-ghost{background:transparent;border:1px solid #ddd;margin-left:6px;font-size:12px;}
#previewContainer{width:95%;max-width:600px;margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;}
.preview-doc{border:1px solid #ccc;padding:10px;margin-bottom:12px;border-radius:8px;background:#fffbe6;}
#paymentModal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:1000;}
#paymentModal > div{background:white;border-radius:12px;padding:18px;max-width:400px;width:100%;}
#pmMsg{margin-top:8px;color:crimson;}
.signature-pad{border:1px solid #ccc;border-radius:8px;width:100%;height:50px;background:#fff;margin-top:8px;}
input.editable{font-weight:bold;font-size:14px;text-align:center;margin-bottom:8px;}
.photo-flottante{float:left;margin:4px;padding:4px;border:1px solid #aaa;border-radius:6px;background:#fff;max-width:200px;display:inline-block;}
.photo-flottante img{max-width:100%;display:block;margin-bottom:4px;}
.photo-flottante div{word-wrap:break-word;min-height:20px;}
.fiche70{display:flex; flex-wrap:wrap; gap:12px;}
.colonne{flex:1; min-width:45%;}
textarea, input{font-family:Inter,sans-serif;}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <div class="logo">LF</div>
    <h1>Mini Secr√©tariat</h1>
  </div>
  <div class="small">‚ú® Tous les documents ‚Ä¢ Photos flottantes ‚Ä¢ Fiche 70 noms √©ditable ‚Ä¢ Paiement strict</div>
</header>
<nav class="navbar" id="mainNav"></nav>
<div class="container">
  <main class="main" id="app">
    <p>Bienvenue dans le Mini Secr√©tariat. Choisissez un document pour commencer ‚ú®</p>
  </main>
  <div id="previewContainer"></div>
</div>

<div id="paymentModal">
  <div>
    <h3>Paiement requis</h3>
    <div><strong>B√©n√©ficiaire :</strong> Kono Emini Michel Momo</div>
    <div><strong>OM :</strong> 651475255</div>
    <div><strong>MOMO :</strong> 656050097</div>
    <div style="margin-top:8px">
      <label>Message Mobile Money</label>
      <input id="mmMsg" type="text" placeholder="Copiez le message re√ßu" style="font-size:13px"/>
    </div>
    <div style="margin-top:8px">
      <label>Code Admin / VIP</label>
      <input id="vipInput" type="text" placeholder="Entrez votre code" style="font-size:13px"/>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="verifierPaiementStrict()">Valider</button>
    <button class="btn btn-ghost" onclick="fermerPopup()">Annuler</button>
    <p id="pmMsg"></p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.4/dist/signature_pad.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
const documents=['CV','CarteVisite','LettreMotivation','CNI','ProtocoleAccord','ContratTravail','PlanLocalisation','Fiche70Noms','Rapport','GaleriePhotos'];
const VIP_CODE='233233';
let paiementValide=false;
let nomSignataire='Nom Signataire';
const noms=Array.from({length:70},(_,i)=>'Nom '+(i+1));

const nav=document.getElementById('mainNav');
documents.forEach(doc=>{
  const btn=document.createElement('button');
  btn.textContent=doc.replace(/([A-Z])/g," $1").trim();
  btn.onclick=()=>ouvrirDoc(doc);
  nav.appendChild(btn);
});

function ouvrirDoc(doc){
  const app=document.getElementById('app');
  const photoHTML=(id,title)=>`
    <input type="file" id="${id}" accept="image/*" style="display:none" onchange="afficherPhoto('${id}','img${id}')"/>
    <label for="${id}"><img id="img${id}" class="doc-photo" title="${title}" src=""/></label>`;
  
  let content='';
  if(doc==='CNI'){
    content=`
      <div style="margin-bottom:12px; border:1px solid #000; padding:4px;">
        <input type="file" id="CNIrecto" accept="image/*" style="display:none" onchange="afficherPhoto('CNIrecto','imgCNIrecto')"/>
        <label for="CNIrecto">
          <img id="imgCNIrecto" style="width:100%; height:50mm; object-fit:cover; display:block;" src=""/>
        </label>
      </div>
      <div style="margin-bottom:12px; border:1px solid #000; padding:4px;">
        <input type="file" id="CNIverso" accept="image/*" style="display:none" onchange="afficherPhoto('CNIverso','imgCNIverso')"/>
        <label for="CNIverso">
          <img id="imgCNIverso" style="width:100%; height:50mm; object-fit:cover; display:block;" src=""/>
        </label>
      </div>`;
  } else if(doc==='Fiche70Noms'){
    content='<div class="fiche70">';
    content+='<div class="colonne">'+noms.slice(0,35).map(n=>`<input value="${n}" style="width:100%;margin-bottom:2px"/>`).join('')+'</div>';
    content+='<div class="colonne">'+noms.slice(35).map(n=>`<input value="${n}" style="width:100%;margin-bottom:2px"/>`).join('')+'</div>';
    content+='</div>';
  } else if(doc==='GaleriePhotos'){
    content=`<div id="galleryContainer"></div>
             <button class="btn btn-ghost" onclick="ajouterPhotoFlottante()">‚ûï Ajouter photo</button>`;
  } else if(doc==='ProtocoleAccord'){
    content=`
      <textarea style="width:100%; min-height:150px;">Contenu du protocole...</textarea>
      <div id="signatairesContainer" style="margin-top:12px;">
        <h4>Signataires :</h4>
        <div><input placeholder="Nom signataire 1" style="width:100%; margin-bottom:4px;"/></div>
      </div>
      <button class="btn btn-ghost" onclick="ajouterSignataire()">‚ûï Ajouter signataire</button>
    `;
  } else {
    content=`${photoHTML(doc+'Photo',doc)}<textarea>Votre contenu...</textarea>`;
  }

  content+=`<canvas id="signaturePad" class="signature-pad"></canvas>
<input class="editable" id="signataireInput" placeholder="Nom signataire"/>
<button class="btn btn-ghost" onclick="clearSignature()">Effacer signature</button>
<button class="btn btn-primary" onclick="exportPDF('${doc}')">üìÑ T√©l√©charger PDF</button>
<button class="btn btn-ghost" onclick="app.innerHTML='<p>Bienvenue dans le Mini Secr√©tariat...</p>'">Retour</button>`;
app.innerHTML=`<h2 class="doc-title handwritten">${doc.replace(/([A-Z])/g," $1").trim()}</h2>`+content;

const canvas=document.getElementById('signaturePad');
window.signaturePad=new SignaturePad(canvas);

const signInput=document.getElementById('signataireInput');
signInput.value=nomSignataire;
signInput.addEventListener('input',()=>{nomSignataire=signInput.value;});

document.querySelectorAll('textarea').forEach(t=>{
  t.addEventListener('input',()=>{t.style.height='auto';t.style.height=t.scrollHeight+'px';});
});
}

function ajouterSignataire(){
  const container = document.getElementById('signatairesContainer');
  const count = container.querySelectorAll('input').length + 1;
  const div = document.createElement('div');
  div.innerHTML = `<input placeholder="Nom signataire ${count}" style="width:100%; margin-bottom:4px;"/>`;
  container.appendChild(div);
}

function afficherPhoto(inputId,imgId){
  const input=document.getElementById(inputId);
  const img=document.getElementById(imgId);
  if(input.files && input.files[0]){
    img.src = URL.createObjectURL(input.files[0]);
    img.onload = () => URL.revokeObjectURL(img.src);
  }
}

function ajouterPhotoFlottante(){
  const container=document.getElementById('galleryContainer');
  const id='photo'+Date.now();
  const div=document.createElement('div');
  div.className='photo-flottante';
  div.innerHTML=`
    <input type="file" accept="image/*" onchange="chargerImageFlottante(event,'${id}')">
    <img id="img${id}" src=""/>
    <div contenteditable="true">Commentaire...</div>`;
  container.appendChild(div);
}

function chargerImageFlottante(e,id){
  const img=document.getElementById('img'+id);
  const file=e.target.files[0];
  if(file){
    img.src = URL.createObjectURL(file);
    img.onload = () => URL.revokeObjectURL(img.src);
  }
}

function clearSignature(){window.signaturePad.clear();}
function ouvrirPopup(){document.getElementById('paymentModal').style.display='flex'; document.getElementById('pmMsg').textContent='';}
function fermerPopup(){document.getElementById('paymentModal').style.display='none';}

function verifierPaiementStrict(){
  const msg = document.getElementById('mmMsg').value.trim();
  const vip = document.getElementById('vipInput').value.trim();
  const pmMsg = document.getElementById('pmMsg');
  pmMsg.textContent = '';
  let valide = false;

  if (vip === VIP_CODE) {
    valide = true;
  } else {
    const regex = /Kono\s+Emini\s+Michel\s+Momo|651475255|656050097/i;
    const regexMontant = /\b100\s?(F|FCFA|XAF)\b/i;
    const regexId = /(ID|TID)\s?[:\-]?\s?\w+/i;
    const regexDate = /\d{2}\/\d{2}\/\d{4}|\d{2}:\d{2}/;

    if (
      regex.test(msg) &&
      regexMontant.test(msg) &&
      regexId.test(msg) &&
      regexDate.test(msg)
    ) {
      valide = true;
    }
  }

  if (valide) {
    paiementValide = true;
    fermerPopup();
    alert('Paiement valid√© ‚úÖ');
  } else {
    paiementValide = false;
    pmMsg.textContent = 'Message ou code invalide ‚ùå. V√©rifiez le nom, le num√©ro, le montant, l‚ÄôID et la date.';
  }
}

async function exportPDF(docName){
  if(!paiementValide){ ouvrirPopup(); return; }

  const app = document.getElementById('app');

  // Attendre que toutes les images soient charg√©es
  const images = Array.from(app.querySelectorAll('img'));
  await Promise.all(images.map(img => {
    if(img.complete) return Promise.resolve();
    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
  }));

  const textareas = Array.from(app.querySelectorAll('textarea'));
  const backups = [];
  textareas.forEach(t => {
    const div = document.createElement('div');
    div.style.whiteSpace = 'pre-wrap';
    div.style.fontSize = window.getComputedStyle(t).fontSize || '12px';
    div.style.lineHeight = window.getComputedStyle(t).lineHeight || '1.4';
    div.style.background = window.getComputedStyle(t).backgroundColor || '#fff8dc';
    div.style.padding = window.getComputedStyle(t).padding || '6px';
    div.style.marginBottom = '8px';
    div.textContent = t.value;
    backups.push({ t, div });
    t.parentNode.replaceChild(div, t);
  });

  let sigImgEl = null;
  if(window.signaturePad && !window.signaturePad.isEmpty()){
    sigImgEl = document.createElement('img');
    sigImgEl.src = window.signaturePad.toDataURL();
    sigImgEl.style.width='120px';
    sigImgEl.style.display='block';
    sigImgEl.style.marginTop='8px';
    app.appendChild(sigImgEl);
  }

  const signText = document.createElement('div');
  signText.textContent = 'Signataire : ' + (nomSignataire || '');
  signText.style.fontSize = '11px';
  signText.style.marginTop = '6px';
  app.appendChild(signText);

  const canvas = await html2canvas(app,{scale:2,useCORS:true,allowTaint:true});

  const pdf = new jspdf.jsPDF('p','mm','a6');
  const pageWidthMm = pdf.internal.pageSize.getWidth();
  const pageHeightMm = pdf.internal.pageSize.getHeight();
  const pxPerMm = canvas.width / pageWidthMm;
  const pageHeightPx = Math.floor(pageHeightMm * pxPerMm);

  let y=0, pageIndex=0;
  while(y < canvas.height){
    const sliceHeight = Math.min(pageHeightPx, canvas.height - y);
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = canvas.width;
    tmpCanvas.height = sliceHeight;
    const tmpCtx = tmpCanvas.getContext('2d');
    tmpCtx.drawImage(canvas,0,y,canvas.width,sliceHeight,0,0,canvas.width,sliceHeight);
    const imgData = tmpCanvas.toDataURL('image/png');
    const sliceHeightMm = sliceHeight/pxPerMm;
 if (pageIndex > 0) pdf.addPage();
pdf.addImage(imgData, 'PNG', 0, 0, pageWidthMm, sliceHeightMm);

pdf.setFontSize(8);
pdf.text("¬© LesFacilitateurs Middleman 651475255", 5, pageHeightMm - 5);

y += sliceHeight;
pageIndex++;
}

// Restaurer les textarea originaux
backups.forEach(({ t, div }) => { 
  if (div.parentNode) div.parentNode.replaceChild(t, div); 
});

// Supprimer la signature temporaire et le nom du signataire
if (sigImgEl && sigImgEl.parentNode) sigImgEl.parentNode.removeChild(sigImgEl);
if (signText && signText.parentNode) signText.parentNode.removeChild(signText);

pdf.save(`${docName}.pdf`);
}
</script>
</body>
</html>